# AI-control-P3D
The possible way to use AI to control planes in flight simulation.

This is a record of a whim from my high school when I established a flight simulation club. I always wonder whether AI could completely handle the control of a plane. After two years of study at UC San Diego, I am here to explore a possible way to practice AI algorithms and fulfill my wonders.

## Target

The program is made for achieving control of a plane in the flight simulation (the P3D v4 platform would be used). AI would directly decide and change all flight variables without using the Autopilot from the plane, which means that AI would manage all manual flight procedures by using traditional PID auto control, including:

The essential altitude and velocity holding mode.

The auto heading mode, the auto climbing mode, and the auto descent mode.

Correctly follow the flight route, follow SID (standard instrument departure) to take off, and IAP/STAR (Instrument Approach ProcedureStandard Terminal Arrival) to land.

### Basic setup
1. Flight environment
P3D version 4 would be used to set up the Flight environment since it has SDK. P3D would be a review system and show the flight altitude. The tactview would also be used as recording and replay. However, the user of P3D would change from human to AI.
2. Plane choice
Cessna 172 would be used in AI flight simulation. Since AI's target is to control the plane completely, I have to use an open-source plane model, where all aerodynamic data are accessible.
JsbSIM in FlightGear would be a possible choice.
3. Core task
Read flight altitude from JsbSim. The pitch, roll, rudder, and throttle control are generated by the core task to achieve flight control. Send the flying attitude back to P3D for display. The core task is to implement hierarchical control.


## New Update on Wednesday, 09/13/2023
I chose c# as the development language since it would save more time for memory allocation.

Mainly referred to Managed data Request program in SDK learning Center

Remindful information during development:
1. Must use x64 platform configuration.
2. The Method "protected override void defWndProc(ref Message m)" is not used, but the program must contain this method.
3. P3D data interface:
   Receiving data in InitDataRequest.
   
   Events happen in InitClientEvent

Next step, figure out how to load a given scenario and how to control the position of the plane.

## New Update on Sunday, 09/24/2023
The new function has been updated, and the program can load, freeze, and activate an assigned scenario now.

The name of the scenario would be saved as xml file.

More information is provided below:

### 1. To control a plane in P3D
   #### a. To understand the definition of the Simulation variable, you could search for the variable definition in SDK Helper.
   
   for example, if the program has to control the plane's position and attitude, by searching among Simulation Variables, then it needs to change these variables:
   
   "Plane Latitude",
   
   "Plane Longitude",
   
   "Plane Altitude",
   
   "PLANE PITCH DEGREES",
   
   "PLANE BANK DEGREES",
   
   "PLANE HEADING DEGREES TRUE"
#### b. In InitDataRequest, the program needs to define variables.

                simconnect.AddToDataDefinition(P3d_api_data.DEFINITIONS.DEFINITION_SET_POSITION, "Plane Latitude", "degrees", SIMCONNECT_DATATYPE.FLOAT64, 0.0f, SimConnect.SIMCONNECT_UNUSED);
   
                simconnect.AddToDataDefinition(P3d_api_data.DEFINITIONS.DEFINITION_SET_POSITION, "Plane Longitude", "degrees", SIMCONNECT_DATATYPE.FLOAT64, 0.0f, SimConnect.SIMCONNECT_UNUSED);
                
                simconnect.AddToDataDefinition(P3d_api_data.DEFINITIONS.DEFINITION_SET_POSITION, "Plane Altitude", "feet", SIMCONNECT_DATATYPE.FLOAT64, 0.0f, SimConnect.SIMCONNECT_UNUSED);
                
                simconnect.AddToDataDefinition(P3d_api_data.DEFINITIONS.DEFINITION_SET_POSITION, "PLANE PITCH DEGREES", "degrees", SIMCONNECT_DATATYPE.FLOAT64, 0.0f, SimConnect.SIMCONNECT_UNUSED);
                
                simconnect.AddToDataDefinition(P3d_api_data.DEFINITIONS.DEFINITION_SET_POSITION, "PLANE BANK DEGREES", "degrees", SIMCONNECT_DATATYPE.FLOAT64, 0.0f, SimConnect.SIMCONNECT_UNUSED);
                
                simconnect.AddToDataDefinition(P3d_api_data.DEFINITIONS.DEFINITION_SET_POSITION, "PLANE HEADING DEGREES TRUE", "degrees", SIMCONNECT_DATATYPE.FLOAT64, 0.0f, SimConnect.SIMCONNECT_UNUSED);
                
#### c. Register Data Structure.

   simconnect.RegisterDataDefineStruct< P3d_api_data.Struct_Pos >(P3d_api_data.DEFINITIONS.DEFINITION_SET_POSITION);
   
#### d. the structure should follow the same sequence as the data.

   public struct Struct_Pos

        {            
            public double latitude;
            public double longitude;
            public double altitude;
            public double pitch;
            public double bank;
            public double head;     
        };


#### e. the program could send data by 

               simconnect.SetDataOnSimObject(P3d_api_data.DEFINITIONS.DEFINITION_SET_POSITION, FlightID, 0, s1);


### 2. Set SIMCONNECT_OBJECT_ID as 0 in SetDataOnSimObject

   SimConnect_SetDataOnSimObject(

     HANDLE  hSimConnect,
     SIMCONNECT_DATA_DEFINITION_ID  DefineID,
     SIMCONNECT_OBJECT_ID  ObjectID,
     SIMCONNECT_DATA_SET_FLAG  Flags,
     DWORD  ArrayCount,
     DWORD  cbUnitSize,
     void*  pDataSet
   );

### 3. Define a new ticker to simulate data.
### 4. A bug may happen when sending new attitudes to planes
   The plane swings and continues to fly when the program stops sending data.
   It might be caused by conflicts between this program and the original flight simulation model. 
   So, the program should freeze the original flight model first.
   
By searching the Simulation variables, I found:
"IS Latitude Longitude freeze on", 
"IS Altitude freeze on", 
"IS Attitude freeze on",

Update them, Register, and define the structure.

//FREEZE POSITION ALTITUDE AND ATTITUDE

                simconnect.AddToDataDefinition(P3d_api_data.DEFINITIONS.DEFINITION_FREEZE, "IS Latitude Longitude freeze on", "BOOL", SIMCONNECT_DATATYPE.FLOAT64, 0.0f, SimConnect.SIMCONNECT_UNUSED);
                simconnect.AddToDataDefinition(P3d_api_data.DEFINITIONS.DEFINITION_FREEZE, "IS Altitude freeze on", "BOOL", SIMCONNECT_DATATYPE.FLOAT64, 0.0f, SimConnect.SIMCONNECT_UNUSED);
                simconnect.AddToDataDefinition(P3d_api_data.DEFINITIONS.DEFINITION_FREEZE, "IS Attitude freeze on", "BOOL", SIMCONNECT_DATATYPE.FLOAT64, 0.0f, SimConnect.SIMCONNECT_UNUSED);
                 simconnect.RegisterDataDefineStruct<P3d_api_data.Struct_Freeze>(P3d_api_data.DEFINITIONS.DEFINITION_FREEZE);
                 
//Register

                  this.simconnect.OnRecvSimobjectData += new SimConnect.RecvSimobjectDataEventHandler(Simconnect_OnRecvSimobjectData);
                  
//define the struct

  public struct Struct_Freeze
  
        {        
            public double lat_long_flag;
            public double altitdue_flag;
            public double attitude_flag;              
        };

## New Update on Sunday, 12/31/2023, Merry Chrismas!
finally back to work, last updates in 2023.
### 1. setting JSBsim interface
Plane choice is decided by jsbsim args, e.g.:
    socket.xml C172_test.xml --realtime
### 2. using socket.xml to define args and frequency
In Data_out folder:
    set input ip to localhost, port 1138, protocol UDP, rate = 100
    <output name="127.0.0.1" type="SOCKET" port="1138"  protocol="UDP" rate="100" precision = "10">
Plane Information, Plane vectors included for now:
    Plane position and attitude:
        <property> position/h-sl-meters </property>
        <property> velocities/vtrue-fps </property>
        <property>position/lat-gc-deg</property>
        <property>position/long-gc-deg</property>
        <property> attitude/roll-rad</property>
        <property> attitude/pitch-rad</property>
        <property> attitude/heading-true-rad</property>
    Plane speed vectors in all directions:
        <property> velocities/v-north-fps</property>
        <property> velocities/v-east-fps</property> 
        <property> velocities/v-down-fps</property> 
        <property> velocities/mach</property>
    Plane Angular Velocity:
        <property> velocities/phidot-rad_sec</property>
        <property> velocities/thetadot-rad_sec</property>
        <property> velocities/psidot-rad_sec</property>
    Plane vertical accelerations:
        <property> accelerations/Nz</property>
    Plane fuel:
        <property> propulsion/total-fuel-lbs</property>
Output format, the data should follow csv format and their sequence defined in sock.xml, e.g.:
    "<LABELS> ,Time,h-sl-meters,vtrue-fps,lat-gc-deg,long-gc-deg,roll-rad,pitch-rad,heading-true-rad,
    v-north-fps,v-east-fps,v-down-fps,mach,phidot-rad sec,thetadot-rad sec,psidot-rad sec,Nz,total-fuel-lbs\n"

### 3. C172_test.xml launch args
Open C172_test.xml
Set aircraft to c172r, initial it as reset00
    <use aircraft="c172r" initialize="reset00"/>
c172r means it follows aircraft/c172r/c172r.xml.
reset00 means at aircraft/c172r/reset00.xml, setting initial altitude, position, velocity.
define input port:
    <input port="5140" type="QTJSBSIM" protocol="UDP" rate="100">
define input variables, which is also the output gained from algroithm, csv format applied.
    <property> fcs/throttle-cmd-norm[0]</property>
    <property> fcs/elevator-cmd-norm </property> 
    <property> fcs/aileron-cmd-norm </property> 
    <property> fcs/rudder-cmd-norm </property> 
define start/end time for simulation
    <run start="0.0" end="7200" dt="0.008333">
#### run mode set to "-realtime"
#### add jsbsim and its related files to the project.

### Complete main functionality of the project

launch jsbsim,
using thread, receive input from jsbsim udp, extract position, altitiude, update to P3D.
According to jsbsim reference manual, we could complete a auto control for horizonal stabiliser trim.



   
   
   
